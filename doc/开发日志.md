# 开发日志（markdownedit）

本文档用于按迭代记录每次开发内容（做了什么、改了哪些文件、当前状态与遗留问题），便于后续对齐 PRD 与界面原型、以及回归排查。

## 2026-01-24

### 1) PRD/原型阅读与技术方案落地

- 目标：读取 PRD 与原型文档，形成可执行的开发方案（性能优先 + 快速交付）。
- 结果：
  - 形成 Tauri v2 + React/TS 的总体方案；导出策略选择“先可用”。
  - 补充原型 `3.1 顶部工具栏` 的分区与交互规范到开发方案。
- 产物/文件：
  - `doc/开发方案.md`

### 2) 工程初始化（Tauri v2 + React + Vite）

- 目标：建立可运行的工程骨架，作为后续 M1/M2 迭代载体。
- 结果：
  - 初始化 Tauri v2 + React TS 项目结构与基础脚本。
  - 增加 `.gitignore` 以忽略构建产物与 Tauri target。
- 产物/文件：
  - `package.json` / `package-lock.json`
  - `src/`、`public/`、`src-tauri/`
  - `.gitignore`

### 3) 本地构建环境修复（cargo/link 工具链问题）

- 问题：`npm run tauri dev` 报错 `cargo metadata ... program not found`（终端 PATH 无 cargo）。
- 处理：
  - 增加 `scripts/tauri.cmd`：启动前自动补齐 `%USERPROFILE%\\.cargo\\bin`，并尽力加载 VS BuildTools 的开发环境。
  - 将 `npm run tauri` 指向 `scripts\\tauri.cmd`，降低使用门槛。
- 产物/文件：
  - `scripts/tauri.cmd`
  - `package.json`（scripts 调整）
  - `README.md`（补充运行说明与排障提示）

### 4) M1：UI 五区布局 + 文件树/工作区 + 打开/保存/最近文件

- 目标：按原型五区布局先跑通“能开、能写、能存”。
- 结果：
  - 五区布局：顶部工具栏 / 左侧侧边栏 / 中间编辑区 / 右侧预览区（分栏用）/ 底部状态栏。
  - Rust 侧命令：
    - 扫描工作区目录树（仅保留包含 `.md` 的目录分支）
    - 读取/写入文本文件
  - 前端功能：
    - 选择工作区（目录对话框）后渲染文件树
    - 打开 `.md` 文件加载到编辑区
    - 保存/另存为（写入磁盘）
    - 最近文件（最多 20）存本地 storage
- 产物/文件（核心）：
  - `src-tauri/src/lib.rs`（`scan_workspace` / `read_text_file` / `write_text_file`）
  - `src-tauri/capabilities/default.json`
  - `src/App.tsx`、`src/App.css`

### 5) 修复：打开工作区/打开文件无反应（Tauri capabilities）

- 问题：点击“打开工作区/打开文件”不弹窗。
- 根因：未在 `src-tauri/capabilities/default.json` 授权 `dialog` 权限。
- 修复：
  - 增加 `dialog:default` 权限集。
  - 前端对 open/save 增加 try/catch，失败时给出明确提示。
- 文件：
  - `src-tauri/capabilities/default.json`
  - `src/App.tsx`

### 6) M1：状态栏完善（字数/模式/保存状态）

- 目标：按原型状态栏核心信息落地。
- 结果：
  - 字数：CJK 字符数 + 英文/数字 token 数（MVP 口径）
  - 模式：所见即所得 / 源码 / 分栏预览
  - 保存状态：已保存 / 未保存（dirty）
- 文件：
  - `src/App.tsx`

### 7) M1->M2 过渡：编辑三模式框架 + 分栏预览基础

- 目标：先保证“切换正确”，再逐步增强编辑能力。
- 结果：
  - 三模式切换：
    - 所见即所得：TipTap（ProseMirror）
    - 源码：textarea（Markdown）
    - 分栏预览：左侧编辑 + 右侧实时渲染
  - 分栏拖拽：支持拖拽分隔条调整比例，最小宽度约束（左>=180px、右>=200px）
  - 内容一致性：
    - Markdown 作为单一事实源
    - WYSIWYG 输入做 300ms 防抖同步为 Markdown；切换/保存时再强制同步一次
- 文件：
  - `src/App.tsx`、`src/App.css`

### 8) M2（预览侧）：GFM 全量（表格/任务列表）+ 脚注/高亮

- 目标：先在预览渲染侧把 PRD 的语法“看得见”打通。
- 结果（分栏预览右侧）：
  - 表格：markdown-it 默认支持 + 预览样式
  - 任务列表：`markdown-it-task-lists`
  - 脚注：`markdown-it-footnote`
  - 高亮：`markdown-it-mark`（`==text==` -> `<mark>`）
  - 安全：DOMPurify 放行任务列表/脚注必要的 tag/attr
- 文件：
  - `src/App.tsx`、`src/App.css`、`src/types.d.ts`
  - `package.json` / `package-lock.json`

### 9) 原型 3.1：顶部工具栏分区落地与功能实现

- 目标：将原型 `3.1 顶部工具栏（50px）` 的“文件/格式/模式与设置”分区在产品中体现并可用。
- 结果：
  - 左侧（文件）：Logo（MVP：清空工作区）+ 文件下拉（新建/打开文件/打开工作区/保存/另存为/导出占位）
  - 中间（格式）：文本格式/段落格式/插入 三组按钮（在 WYSIWYG 走 TipTap 命令；在 Markdown/分栏插入语法）
  - 右侧：模式切换（已存在）+ 主题切换（明暗，记忆）+ 设置入口（偏好/快捷键/帮助占位）
- 文件：
  - `doc/开发方案.md`（补充 3.1 规范）
  - `src/App.tsx`、`src/App.css`

### 10) 工具栏布局调整（按最新反馈）

- 需求调整：
  - 格式工具栏（加粗/斜体/删除线等）移动到“文件”菜单下方
  - “设置”改为与“文件”一致的下拉菜单形态
  - 模式切换（所见即所得/源码/分栏）移动到“文件名栏”右侧
- 实现：
  - 顶部工具栏改为两行：上行（Logo + 文件菜单 + 主题 + 设置菜单），下行（格式工具栏）
  - 模式切换从顶栏移除，放入编辑区的文件名栏右侧（各模式 header 统一展示）
  - 更新开发方案中顶部工具栏描述，注明该布局调整
- 文件：
  - `doc/开发方案.md`
  - `src/App.tsx`
  - `src/App.css`

### 11) 修复：所见即所得插入表格后落盘为 HTML `<table>`

- 问题：在“所见即所得”模式插入表格，切换到源码/保存后，Markdown 内容中出现原始 HTML `<table>...</table>`。
- 根因：Turndown 使用 `turndown-plugin-gfm` 的 `tables` 规则时，若无法识别“表头行”，会对表格执行 `keep()`，导致 HTML 表格被原样保留。
- 修复：
  - 不再直接启用 `gfm`（避免 tables 的 keep 行为）
  - 保留 `highlightedCodeBlock`、`taskListItems` 规则
  - 自定义 `tableAny` 规则：无论是否存在 `<th>`，都强制转换为 Markdown 表格（MVP：单元格内容做简化转换并转义 `|`）
  - 补回删除线规则（输出 `~~text~~`）
- 文件：
  - `src/App.tsx`

### 12) Markdown 大纲（跳转/高亮）

- 目标：实现原型侧边栏“大纲视图”，支持标题列表、点击跳转、当前位置高亮。
- 实现：
  - 侧边栏顶部增加 Tab：`文件列表` / `大纲`
  - 大纲数据源：
    - 所见即所得：从 TipTap（ProseMirror）文档中提取 heading 节点（level/text/pos）
    - 源码/分栏：从 Markdown 文本解析 `#..######` 标题（跳过代码块围栏 ```/~~~）
  - 跳转：
    - 所见即所得：设置 ProseMirror selection 到对应 heading，并滚动到可见
    - 源码/分栏：设置 textarea 光标到标题行起始 offset，并滚动到该行
  - 高亮：当前光标所在标题高亮（所见即所得基于 selection.from，源码/分栏基于当前行号）
- 文件：
  - `src/App.tsx`
  - `src/App.css`

### 13) 图片插入（粘贴/拖拽/落盘相对路径）

- 目标：实现图片插入 P0（剪贴板粘贴 / 拖拽 / 选择文件），落盘到本地并使用相对路径引用。
- 规则：
  - 默认存储到当前 Markdown 文件同目录的 `img/` 文件夹（不存在自动创建）
  - 插入到文档中使用相对路径：`![alt](img/xxx.png)`
  - 若当前为“未命名”文件：插入前会弹出“另存为”选择 Markdown 保存路径（仅用于确定 img/ 落盘目录；内容仍保持未保存状态）
- 实现：
  - 顶部工具栏“图片”改为选择本地图片文件 → 复制到 `img/` 并插入引用
  - Markdown/分栏 textarea：支持粘贴图片、拖拽图片文件插入
  - 所见即所得：支持粘贴/拖拽插入；展示使用 `convertFileSrc(绝对路径)`，同时在 `<img>` 上保留 `data-md-src="img/..."` 以保证 turndown 落盘为相对路径
  - 预览渲染：markdown-it 渲染图片时会根据当前文件目录把相对路径转换为可加载的本地 asset URL（convertFileSrc）
  - Rust 命令：新增二进制写入与文件复制命令，确保 `img/` 目录自动创建
- 文件：
  - `src/App.tsx`
  - `src/App.css`
  - `src-tauri/src/lib.rs`
  - `src-tauri/Cargo.toml`

## 当前已实现清单（截至本日志）

- UI 五区布局（顶栏/侧栏/编辑区/预览区/状态栏）
- 工作区文件树（筛选 `.md`）+ 打开/保存/另存为 + 最近文件（20）
- 编辑三模式框架 + 分栏拖拽预览
- 预览侧语法：表格/任务列表/脚注/高亮
- 顶部工具栏：文件菜单 + 格式工具 + 模式/主题/设置入口

## 已知限制 / 后续建议

- “文件下拉菜单”目前为自绘下拉（非系统菜单）；导出/偏好/快捷键/帮助暂为占位。
- 语法“可编辑”仍以 Markdown 模式为主；WYSIWYG 对任务列表/脚注等尚未做完整的可视化编辑与 Markdown round-trip 校验。
- 后续建议按里程碑继续：大纲视图、图片本地入库（img/ 相对路径）、导出 HTML/PDF/DOCX（先可用）、WebDAV 同步、回收站/历史版本。
