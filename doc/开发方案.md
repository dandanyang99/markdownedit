# Markdown 编辑器 V1.0 开发方案（性能优先 + 快速交付）

本文档基于《Markdown 编辑器产品功能 PRD 框架（V1.0）》与《Markdown编辑器V1.0 界面原型说明文档》，给出 V1.0（MVP）落地开发方案。目标是在保证运行时性能（启动/内存/大文件编辑）前提下尽快交付可用版本。

## 1. 总体结论（选型与取舍）

### 1.1 推荐技术路线

- 桌面壳：Tauri v2（Rust 后端）+ React + TypeScript + Vite
- 编辑内核：
  - 所见即所得（默认）：TipTap（ProseMirror）
  - 源码模式：CodeMirror 6
  - 分栏预览：同一份 Markdown 文本驱动预览渲染
- Markdown 渲染/AST：remark/rehype 统一管线（GFM、脚注、任务列表、表格、高亮等）
- 公式/图表（P1）：KaTeX + Mermaid
- 同步（P1）：WebDAV
- 协作（P1 验证）：Yjs + 轻量 websocket relay（2人协作）
- 导出（P0）：HTML/PDF/DOCX
  - HTML：本地渲染管线直接产出
  - PDF：HTML -> PDF（MVP：html-to-pdfmake + pdfmake，先保证可用；后续可替换 Chromium 提升保真）
  - DOCX：Markdown 解析 -> DOCX（MVP：docx 库，先保证可用；后续再追求高保真）

### 1.2 关键产品取舍（已确认）

- V1.0 导出选择“先可用（版式基本正确）”，不追求高保真排版；后续迭代替换导出引擎。

## 2. 架构设计（对应 PRD：本地优先 + 轻量协作）

### 2.1 分层架构

- UI 层（按原型五大区域）
  - 顶部工具栏（50px）
  - 左侧侧边栏（默认 220px，可折叠 40px；文件列表/大纲）
  - 中间编辑区域（核心）
  - 右侧预览区（仅分栏模式显示，支持拖拽分隔线）
  - 底部状态栏（24px：字数/模式/同步状态等）
- 编辑器层（编辑模式与渲染）
  - 模式切换：所见即所得 / 源码 / 分栏预览；切换尽量保持光标与滚动锚点
  - 统一渲染管线：Markdown -> AST -> HTML（预览/导出/大纲共用，避免三套逻辑不一致）
- 本地能力层（Rust/Tauri Commands）
  - 文件系统：工作区、CRUD、搜索、最近文件、自动保存
  - 版本与回收站：历史快照、删除回收
  - 同步：WebDAV（含冲突副本、日志）
  - 导出：调用导出 sidecar 或本地转换器
- 协作层（最小可用验证）
  - Yjs 文档会话（2人）+ 光标/用户名；断线重连自动合并

### 2.2 “单一事实源”原则（避免返工）

- 磁盘落盘永远是标准 `.md`（不封装、不加密），符合 PRD 的“本地数据主权”。
- WYSIWYG 只是 Markdown 的结构化编辑视图；保存/同步/导出统一基于 Markdown 文本或其 AST。

## 3. 功能模块拆分（按 PRD 优先级）

### 3.1 编辑核心（P0/P1）

- 三模式：所见即所得（默认）/ 源码 / 分栏预览（分隔线可拖拽；最小宽度约束：编辑区>=180px、预览区>=200px）
- GFM 支持（P0）：标题、列表、引用、代码块、链接、表格、任务列表
- 扩展（P0）：脚注、高亮标注
- 高级（P1）：KaTeX 公式（行内/块级）、Mermaid 图表
- 大纲（P1）：基于标题层级生成，点击跳转；当前段落标题高亮
- 查找替换（P0）：Ctrl+F / Ctrl+H（可先做基础版，正则后置）

### 3.2 文件管理（P0/P1）

- 工作区（P0）：打开文件夹、文件树展示
- 文件操作（P0）：新建/重命名/删除/复制粘贴/拖拽移动、最近打开（最多20）
- 自动保存（P0）：默认 30s + 手动 Ctrl+S；状态栏展示“已保存/未保存”
- 版本与回收站（P1）：历史版本（默认保留10份，可配置）+ 回收站（默认30天，可配置）+ diff/恢复

### 3.3 媒体（P0/P1）

- 图片（P0）：拖拽/粘贴/选择文件插入；默认保存到同目录 `img/`，使用相对路径
- 图片增强（P1）：尺寸/对齐/alt 等可后置，先保证“插入-可显示-可导出”

### 3.4 导出（P0/P1）

- P0：HTML / PDF / DOCX
  - HTML：统一渲染管线产出（含主题样式）
  - PDF：HTML -> PDF（MVP：html-to-pdfmake + pdfmake；后续可替换 Chromium 提升保真）
  - DOCX：Markdown 解析 -> DOCX（MVP：docx 库，优先“可用”）
- P1：PDF 页码/水印/页眉页脚等高级选项可后置

### 3.5 同步与协作（P1）

- WebDAV 同步（P1）
  - 同步范围：文件/工作区
  - 同步间隔：实时/5分钟/15分钟/手动
  - 冲突策略：生成“冲突副本（含时间）”，提示手动合并
  - 状态栏：同步中/完成/失败；失败可查看错误日志
- 双人协作（P1 验证）
  - 2人同文档编辑，显示对方光标与用户名
  - 断线重连后 CRDT 合并；延迟目标 <= 500ms（弱网以可用为主）

## 4. 交互与 UI 落地要点（按原型）

- 样式体系：CSS variables（浅色/深色两套），保证原型色值可控
- 顶部工具栏（高度固定 50px，按原型 3.1 落地）：
  - 左侧（文件操作）：Logo（24x24）+「文件」下拉菜单（新建/打开/保存/导出），hover 背景 `#E8F0FE`，菜单项高度 32px
  - 中间（格式工具）：按组排列（文本格式 -> 段落格式 -> 插入功能），图标 16x16，组间距 16px，项间距 8px；未激活 `#666666`，hover/激活 `#4285F4`；点击按压反馈（背景 `#E0E0E0`，下沉 1px）
  - 右侧（设置与主题）：明暗主题切换（18x18，记忆偏好）+「设置」下拉菜单（偏好/快捷键/帮助）
  - 交互调整（实现偏好）：格式工具条移动到「文件」菜单下方一行；模式切换移动到“文件名栏”右侧
- 侧边栏：220px 默认；折叠到 40px 仅显示图标；文件/大纲 Tab 切换
- 分栏预览：拖拽分隔线调整比例；窗口小于最小宽度自动隐藏预览区
- 提示与弹窗：Toast（2秒自动消失）、错误提示（带“重试/详情”）、功能弹窗（400px 规格）

## 5. 里程碑与排期（6-8 周）

### M1（第1-2周）：能写、能存、能开（P0 骨架）

- UI 五区布局 + 文件树/工作区 + 打开/保存/最近文件
- 编辑三模式框架（先保证切换正确）+ 分栏预览基础
- 状态栏：字数、模式、保存状态

### M2（第3周）：语法与体验补齐（P0 完整可用）

- GFM 全量（表格/任务列表）+ 脚注/高亮
- 大纲（跳转/高亮）
- 图片插入（粘贴/拖拽/落盘相对路径）

### M3（第4周）：稳定性与主题（P1 价值点优先）

- 深色/浅色主题 + 专注模式
- 历史版本 + 回收站（含恢复与 diff）

### M4（第5周）：导出打通（P0）

- HTML/PDF/DOCX 导出链路跑通（以“可用”为准）
- 导出设置弹窗与进度反馈

### M5（第6周）：WebDAV 同步（P1）

- 同步配置、状态栏反馈、冲突副本、错误日志

### M6（第7-8周）：双人协作 MVP + 性能专项 + 发布

- 2人协作（光标/用户名/重连）
- 大文件（10万字级）/多文档性能优化与回归
- 打包发布与验收清单

## 6. 测试与验收（建议最低集）

- 功能验收：
  - 三模式切换、分栏拖拽、侧边栏折叠
  - 表格/任务列表/脚注/高亮；KaTeX/Mermaid（若纳入本期）
  - 文件 CRUD + 自动保存 + 最近文件
  - 版本/回收站（恢复 + diff）
  - 导出 HTML/PDF/DOCX（可用优先）
  - WebDAV 同步 + 冲突副本
  - 2人协作（可连通、可编辑、可重连）
- 自动化建议：
  - Markdown -> HTML 快照测试（固定样例文档集）
  - 同步冲突用例回归（同文件两端改动）

## 7. 风险与应对

- 所见即所得与 Markdown 映射复杂：坚持“单一事实源（.md）+ 统一 AST 管线”，对复杂块（表格/图表/公式）优先做“可编辑/可保存/可导出”的最小闭环。
- 导出质量与速度冲突：V1.0 采用 sidecar 与“可用优先”策略，避免阻塞主线；后续替换高保真引擎。
- 同步/协作数据安全：冲突副本 + 历史版本作为兜底，降低数据丢失风险。
