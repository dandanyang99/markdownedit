# Markdown 编辑器开发过程文档

## 项目概述

本项目是一个跨平台的 Markdown 编辑器，采用 Electron + React 技术栈构建。该编辑器支持 Markdown 语法编辑，并提供工具栏一键插入各种 Markdown 格式标签，具有实时预览功能。

## 技术选型

### 主要技术栈
- **Electron**: 用于构建跨平台桌面应用
- **React**: 用于构建用户界面
- **Marked**: Markdown 解析库
- **DOMPurify**: HTML 内容净化库，防止 XSS 攻击
- **原生 JavaScript**: 前端交互逻辑

### 为什么选择这些技术
1. **跨平台**: Electron 可以同时构建 Windows、macOS、Linux 应用
2. **Web 技术栈**: 基于 HTML、CSS、JavaScript，开发效率高
3. **社区生态**: 拥有丰富的第三方库支持
4. **易于维护**: Web 技术成熟，学习成本低

## 项目结构

```
markdownedit/
├── package.json           # 项目配置文件
├── main.js               # Electron 主进程文件
├── README.md             # 项目说明文档
├── 开发过程.md           # 开发过程文档
└── src/
    └── renderer/         # 前端渲染进程
        ├── index.html    # 主页面
        ├── index.js      # 前端逻辑
        └── styles.css    # 样式文件
```

## 详细开发步骤

### 第一步：项目初始化

创建了 `package.json` 文件，配置了项目基本信息和依赖：

```json
{
  "name": "markdown-editor",
  "version": "1.0.0",
  "description": "一个跨平台的 Markdown 编辑器",
  "main": "main.js",
  "scripts": {
    "start": "electron .",
    "dev": "concurrently \"npm run electron-dev\" \"npm run react-dev\"",
    "electron-dev": "nodemon --exec \"npm start\"",
    "react-dev": "cd src/renderer && npm start",
    "build": "npm run build:renderer && npm run build:electron",
    "build:renderer": "cd src/renderer && npm run build",
    "build:electron": "electron-builder --dir"
  },
  "keywords": [
    "markdown",
    "editor",
    "cross-platform"
  ],
  "author": "Your Name",
  "license": "MIT",
  "devDependencies": {
    "electron": "^latest",
    "electron-builder": "^latest",
    "nodemon": "^latest",
    "concurrently": "^latest",
    "@types/node": "^latest",
    "typescript": "^latest"
  },
  "dependencies": {
    "electron-squirrel-startup": "^latest",
    "marked": "^latest",
    "dompurify": "^latest"
  }
}
```

### 第二步：配置 Electron 主进程

创建了 `main.js` 文件，主要功能包括：

1. **窗口管理**: 创建和管理主应用窗口
2. **菜单栏**: 实现文件、编辑、帮助等菜单项
3. **系统集成**: 处理窗口生命周期和系统事件

关键代码片段：
```javascript
const createWindow = () => {
  const mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    minWidth: 800,
    minHeight: 600,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false,
      enableRemoteModule: true
    }
  });

  mainWindow.loadFile(path.join(__dirname, 'src/renderer/index.html'));
};
```

### 第三步：前端页面设计

创建了 `src/renderer/index.html`，作为应用的主界面容器：

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown 编辑器</title>
  <link rel="stylesheet" href="styles.css">
  <!-- 引入 Marked 库用于 Markdown 解析 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- 引入 DOMPurify 用于清理 HTML -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script src="index.js"></script>
</body>
</html>
```

### 第四步：样式设计

创建了 `src/renderer/styles.css`，实现了现代化的 UI 设计：

1. **响应式布局**: 使用 Flexbox 实现编辑区和预览区的分栏布局
2. **美观界面**: 简洁的视觉风格，符合现代审美
3. **用户体验**: 舒适的字体、间距和颜色搭配

### 第五步：核心功能实现

在 `src/renderer/index.js` 中实现了编辑器的核心功能：

#### 1. 实时预览功能
```javascript
function updatePreview() {
  const markdown = editor.value;
  const rendered = marked.parse(markdown);
  preview.innerHTML = DOMPurify.sanitize(rendered);
  
  updateStatusBar();
}
```

#### 2. 工具栏功能
实现了多种常用的 Markdown 格式插入功能：
- 加粗、斜体、标题
- 链接、图片插入
- 列表（有序/无序）
- 代码块和内联代码
- 引用格式

#### 3. 通用插入函数
```javascript
function insertMarkdownSyntax(prefix, suffix, placeholder) {
  const startPos = editor.selectionStart;
  const endPos = editor.selectionEnd;
  const selectedText = editor.value.substring(startPos, endPos);
  
  const textToInsert = selectedText || placeholder;
  
  const before = editor.value.substring(0, startPos);
  const after = editor.value.substring(endPos, editor.value.length);
  
  editor.value = before + prefix + textToInsert + suffix + after;
  
  // 设置新的光标位置
  let newPos;
  if (selectedText) {
    newPos = startPos + prefix.length + selectedText.length + suffix.length;
  } else {
    newPos = startPos + prefix.length;
  }
  
  editor.setSelectionRange(newPos, newPos);
  editor.focus();
  updatePreview();
}
```

#### 4. 状态栏功能
实时显示行数和字符数统计信息。

## 功能特性

### 1. 编辑功能
- 实时 Markdown 语法解析
- 语法高亮显示
- 自动保存草稿

### 2. 工具栏功能
- **B**: 插入加粗语法 `**加粗文字**`
- **I**: 插入斜体语法 `*斜体文字*`
- **H**: 插入标题语法 `### 标题`
- **🔗**: 插入链接语法 `[链接描述](https://)`
- **🖼️**: 插入图片语法 `![图片描述](https://)`
- **•**: 插入无序列表 `- `
- **1.**: 插入有序列表 `1. `
- **{}**: 插入内联代码语法 `` `代码` ``
- ****{}**: 插入代码块语法
- **❝**: 插入引用语法 `> `

### 3. 预览功能
- 实时渲染 Markdown 内容
- 支持所有标准 Markdown 语法
- 安全的 HTML 输出（通过 DOMPurify 净化）

### 4. 状态显示
- 行数统计
- 字符数统计

## 项目特点

### 1. 跨平台兼容
- 使用 Electron 技术，一次开发，多平台部署
- 支持 Windows、macOS、Linux 系统

### 2. 安装配置优化
- 使用国内镜像源加速下载
- 正确的依赖版本号格式
- 解决常见的安装错误

### 2. 用户友好
- 直观的工具栏设计
- 即时预览功能
- 清晰的状态信息显示

### 3. 性能优化
- 响应式的界面更新
- 高效的 Markdown 解析
- 轻量级的依赖库

### 4. 安全性
- 使用 DOMPurify 净化 HTML 输出
- 防止 XSS 攻击
- 安全的内容渲染

## 运行与部署

### 开发环境搭建
1. 安装 Node.js（版本 12.x 或更高）
2. 克隆项目代码
3. 安装依赖：`npm install`
4. 启动开发模式：`npm start`

### 生产环境构建
- 构建应用：`npm run build`

## 常见问题及解决方案

### 1. 版本号格式错误
**问题**: `npm error code EINVALIDTAGNAME` - Invalid tag name "^latest" of package

**解决方案**: 将 package.json 中的依赖版本号从 `"^latest"` 修改为 `"latest"`

### 2. 权限或文件占用错误
**问题**: `npm error code EBUSY` - resource busy or locked

**解决方案**: 
- 终止相关的 node.exe 和 electron.exe 进程
- 删除被占用的 node_modules 目录
- 重新安装依赖

### 3. 网络超时错误
**问题**: `npm error RequestError: connect ETIMEDOUT`

**解决方案**: 
- 使用国内 npm 镜像源安装依赖
- 配置 .npmrc 文件指定 Electron 镜像源

## 问题修复记录

### Markdown 编辑框不显示问题

**问题现象**: 应用启动后窗口正常显示，但 Markdown 编辑框不可见，工具栏按钮功能缺失。

**根本原因**: 
1. [index.js](file://e:\work\markdownedit\src\renderer\index.js) 文件中代码不完整，工具栏按钮事件绑定缺失
2. CSS 样式中编辑框缺少边框和内边距，导致视觉上不明显

**解决方案**:
1. 补充完整的工具栏按钮事件绑定，包括：
   - 标题按钮（#）
   - 链接和图片插入
   - 列表、代码、引用等功能按钮
   - 代码块插入功能
   - 编辑器内容变化监听和预览更新
2. 改进 CSS 样式，使编辑框更加明显：
   - 为编辑器添加边框
   - 添加内边距
   - 为富文本编辑模式添加适当的样式

**验证结果**: 修复后编辑器正常显示，所有工具栏按钮功能正常工作。

### 富文本编辑模式功能不完善问题

**问题现象**: 在富文本模式下，工具栏按钮（如加粗、斜体等）无法修改富文本编辑器中的文字格式。

**根本原因**: 
1. 工具栏按钮只实现了 Markdown 模式下的功能，没有针对富文本模式实现相应功能
2. 缺少富文本编辑所需的相关函数和事件监听

**解决方案**:
1. 修改 [insertAtCursor](file://e:\work\markdownedit\src\renderer\index.js#L89-L105) 和 [insertMarkdownSyntax](file://e:\work\markdownedit\src\renderer\index.js#L108-L131) 函数，使其能够根据当前模式执行不同的操作
2. 新增 [formatRichText](file://e:\work\markdownedit\src\renderer\index.js#L143-L149) 函数，用于在富文本模式下执行格式化命令
3. 为每个工具栏按钮添加条件判断，根据当前编辑模式执行相应的操作：
   - 在 Markdown 模式下插入 Markdown 语法
   - 在富文本模式下执行相应的格式化命令
4. 添加富文本编辑器的事件监听，包括内容变化和键盘快捷键支持

**验证结果**: 修复后在富文本模式下，工具栏按钮可以正确修改文字格式，支持加粗、斜体、标题、链接、列表等多种格式。

### 富文本模式与预览不一致问题

**问题现象**: 富文本模式下的显示效果与左侧 Markdown 预览区域不一致，不是真正的所见即所得。

**根本原因**: 
1. 富文本编辑器使用默认的样式，而不是与预览区域相同的 Markdown 样式
2. 缺少对应的 CSS 样式规则来匹配 Markdown 渲染效果

**解决方案**:
1. 修改富文本编辑器的字体和行高，使其与预览区域一致
2. 为富文本编辑器添加特定的 Markdown 样式规则，包括：
   - 标题（h1, h2, h3）的边距样式
   - 段落（p）的边距样式
   - 列表（ul, ol, li）的缩进和边距样式
   - 代码块（code, pre）的背景色和边框样式
   - 引用（blockquote）的边框和字体样式
3. 添加滚动条支持，以便处理长内容

**验证结果**: 修复后富文本模式下的显示效果与预览区域保持一致，实现了真正的所见即所得体验。

### 文件夹浏览和目录树功能

**问题现象**: 需要实现第二次需求变更中提到的功能：在窗口左侧显示一个目录树，用户可以打开一个文件夹，该文件夹下的所有.md文件及包含.md文件的子文件夹都显示在这个目录树里，用户可以选择一个md文件在编辑框打开。

**根本原因**: 
1. 缺少文件夹选择功能
2. 缺少目录树显示功能
3. 缺少文件读取和保存功能
4. 缺少前后端通信机制

**解决方案**:
1. 修改 HTML 结构，添加侧边栏容器和目录树区域
2. 更新 CSS 样式，实现左右分栏布局，左侧为目录树，右侧为编辑区域
3. 在主进程中添加 IPC 通信处理函数：
   - `select-folder`: 实现文件夹选择对话框
   - `scan-directory`: 扫描目录并返回包含 .md 文件的目录结构
   - `read-file`: 读取文件内容
   - `save-file`: 保存文件内容
4. 在渲染进程中实现目录树功能：
   - 实现目录树渲染和交互功能
   - 实现文件点击打开功能
   - 实现文件保存功能
   - 添加 Ctrl+S 快捷键支持
5. 添加文件路径跟踪，确保编辑内容能正确保存到原文件

**验证结果**: 修复后实现了完整的文件夹浏览和目录树功能，用户可以选择包含 .md 文件的文件夹，在左侧目录树中浏览和选择文件进行编辑，支持在 Markdown 和富文本模式间切换，并可保存修改。

## 问题修复记录

### 目录树文件打开时预览框不更新问题

**问题现象**: 当点击目录树中的文件时，文件内容只显示在编辑框中，但预览框的内容不变。

**根本原因**: 
1. 在文件打开的处理函数中，当处于 Markdown 模式时，只更新了编辑器内容，但没有调用 [updatePreview](file://e:\work\markdownedit\src\renderer\index.js#L59-L77)() 函数更新预览框
2. 只有在富文本模式下才调用了 [updatePreview](file://e:\work\markdownedit\src\renderer\index.js#L59-L77)() 函数

**解决方案**:
1. 在文件打开处理函数中，无论当前是哪种编辑模式，都在设置编辑器内容后调用 [updatePreview](file://e:\work\markdownedit\src\renderer\index.js#L59-L77)() 函数
2. 确保预览框始终与编辑框内容保持同步

**验证结果**: 修复后，当点击目录树中的文件时，文件内容会在编辑框和预览框中同时更新，实现了正确的同步显示。

## 问题修复记录

### 目录树功能增强

**问题现象**: 
1. 点击子目录下的文档时，会意外折叠子目录
2. 目录树缺少可视化图标，用户体验不佳
3. 缺少目录展开/折叠的明确指示图标

**根本原因**: 
1. 文件点击事件会冒泡到父文件夹，触发了文件夹的展开/折叠行为
2. 目录树使用纯文本显示，没有图标区分文件和文件夹
3. 没有专门的展开/折叠图标，用户难以识别可操作区域

**解决方案**:
1. 在文件点击事件处理器中添加 `e.stopPropagation()` 防止事件冒泡
2. 在 CSS 中添加 ::before 伪元素，使用 emoji 图标显示文件夹📁和文件📄图标
3. 添加专门的展开/折叠图标（▼/►），并在点击图标时才执行展开/折叠操作
4. 区分点击图标和点击名称的行为：点击图标控制展开/折叠，点击名称仅选中项目

**验证结果**: 修复后，点击文件不再折叠目录，目录树显示了清晰的图标，展开/折叠操作有了明确的视觉指示，用户体验得到显著改善。

## 问题修复记录

### 目录树 UI 美化

**问题现象**: 目录树的样式不够美观，与 Windows 资源管理器风格差异较大，用户体验有待提升。

**根本原因**: 
1. 目录树样式较为简单，缺乏现代感
2. 未参考 Windows 资源管理器的设计风格
3. 颜色搭配和间距不够协调

**解决方案**:
1. 参考 Windows 资源管理器的样式，调整颜色、间距和圆角
2. 优化文件夹和文件的图标大小和间距
3. 调整选中和悬停状态的颜色，使其更接近 Windows 风格
4. 改进子目录的缩进和层级显示
5. 调整展开/折叠图标的样式和颜色

**验证结果**: 修复后，目录树的外观更接近 Windows 资源管理器风格，具有更好的视觉层次和交互反馈，用户体验得到显著提升。

## 问题修复记录

### 目录树 UI 进一步美化

**问题现象**: 用户反馈目录树样式仍然不够美观，与 Windows 资源管理器风格仍有差距。

**根本原因**: 
1. 颜色和间距调整不够精细
2. 缺少现代感的视觉效果
3. 选中状态和悬停状态的交互反馈不够明显

**解决方案**:
1. 参考 Windows 资源管理器的最新设计，调整颜色、间距和圆角
2. 添加更明显的选中状态（蓝色背景）
3. 改进图标颜色和透明度，增加鼠标悬停时的颜色变化
4. 为展开/折叠图标添加背景色和悬停效果
5. 增加目录树容器的边框和背景色，提升整体视觉层次
6. 调整字体粗细和颜色，使文件夹和文件更易区分

**验证结果**: 修复后，目录树的外观更接近 Windows 资源管理器风格，具有更好的视觉层次和交互反馈，用户体验得到进一步提升。

## 问题修复记录

### 目录树展开方向修正（第二次尝试）

**问题现象**: 子目录展开后是横向展开，而不是期望的向右缩进并向下展开的效果。

**根本原因**: 
1. 子目录容器使用了 flex 布局，但父元素也是 flex 布局，导致子目录被横向排列
2. 需要将子目录容器改为块级元素，并通过 margin 实现缩进

**解决方案**:
1. 在 CSS 中将 .tree-children 类从 `display: flex; flex-direction: column;` 改为 `display: block;`
2. 在 JavaScript 中将子目录容器的样式从 `paddingLeft` 改为 `marginLeft`，确保正确的缩进效果
3. 移除不必要的 width 设置，让子目录自然宽度

**验证结果**: 修复后，子目录展开时会向右缩进并向下展开，符合 Windows 资源管理器的风格。

## 未来扩展方向

1. **分栏预览模式**: 已实现左侧编辑（源码/所见即所得可选），右侧实时预览，支持拖拽调整分栏比例
2. **主题切换**: 提供深色/浅色主题选项
3. **导出功能**: 支持导出为 HTML、PDF 等格式
4. **插件系统**: 允许用户自定义扩展功能
5. **同步功能**: 支持云同步编辑内容